input float2 inUV;
input float4 inColor;

Texture0 texDiffuse
{
    filter = nearest;
    repeat = clamp;
}

Texture1 texNormal
{
    filter = nearest;
    repeatY = clamp;
}

Texture2 texDepth
{
    filter = nearest;
    repeatY = clamp;
}

extern matrix invProjMtx;
extern float3 lPos;
extern float4 lColor;
extern float lRadius;

float3 LightPass(float3 pos, float3 normal, float3 lpos, float lradius, float4 lcolor)
{
    float3 dir = lpos - pos;
    float dis = length(dir);
    dir /= dis;
    float intensity = 1 - dis / lradius;
    intensity = clamp(intensity, 0, 1);
    intensity = pow(intensity, 2);
    float dotNormal = clamp(dot(normal, dir), 0, 1);
    intensity *= dotNormal;

    return lcolor.rgb * intensity * lcolor.a;
}

void main()
{
    float4 tdiffuse = texDiffuse(inUV);
    float4 tnormal = texNormal(inUV);
    float4 tdepth = texDepth(inUV);

    // Position
    float4 position = float4(float2(inUV.x, 1 - inUV.y) * 2.0 - 1.0, tdepth.r, 1.0);
    position = mul(position, invProjMtx);
    position /= position.w;

    // normal
    float3 normal = tnormal.xyz * 2.0 - 1.0;

    oColor = tdiffuse;
    oColor.rgb *= LightPass(position.xyz, normal, lPos, lRadius, lColor);
}
